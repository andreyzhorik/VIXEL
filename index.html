<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VIXEL Hub ‚Äî Games</title>
<link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0a0a0a; --bg2:#3D0000; --panel:#150000; --accent:#FF0000; --accent2:#950101; --accent-light:#FF3333;
    --glass: rgba(26,0,0,0.35);
    --muted: rgba(255,255,255,0.7);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;-webkit-font-smoothing:antialiased;color:#fff;background:linear-gradient(135deg,var(--bg1),var(--bg2))}

  .app{display:flex;height:100vh;gap:18px;padding:18px}
  /* Sidebar */
  #sidebar{width:260px;background:linear-gradient(180deg,rgba(0,0,0,0.95),rgba(61,0,0,0.85));padding:24px;border-radius:14px;border:1px solid rgba(255,0,0,0.06);display:flex;flex-direction:column;gap:14px;flex-shrink:0}
  .logo{font-family:'Audiowide',sans-serif;color:var(--accent);font-size:26px;text-align:center;padding:6px 0;text-shadow:0 0 12px rgba(255,0,0,0.12);display:flex;flex-direction:column;align-items:center;gap:10px}
  .logo-icon{width:110px;height:110px;border-radius:16px;background:#0a0000;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,0,0,0.12);box-shadow:0 6px 30px rgba(255,0,0,0.06) inset}
  .logo-icon img{width:90%;height:90%;object-fit:contain;display:block}
  .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
  .nav button{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:10px;color:#fff;cursor:pointer;text-align:left;display:flex;gap:10px;align-items:center}
  .nav button.active{background:linear-gradient(135deg,var(--accent2),var(--accent));box-shadow:0 6px 30px rgba(255,0,0,0.12)}
  .nav .small{opacity:0.85;font-size:13px;color:rgba(255,255,255,0.9)}
  .footer-note{font-size:12px;color:rgba(255,255,255,0.5);margin-top:auto;text-align:center;padding-top:6px}

  /* Main */
  #main{flex:1;display:flex;flex-direction:column;gap:18px}
  .topbar{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:var(--glass);border:1px solid rgba(255,0,0,0.04)}
  .title{font-family:'Audiowide',sans-serif;font-size:22px;color:var(--accent);margin-right:auto}
  .controls{display:flex;gap:8px;align-items:center}
  input.search{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.6);color:#fff;min-width:220px}
  .btn{padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent2),var(--accent));cursor:pointer;color:#fff;font-weight:600}
  .small-btn{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;cursor:pointer}

  /* content panel */
  .panel{flex:1;padding:16px;border-radius:12px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,0,0,0.06);overflow:hidden;display:flex;flex-direction:column;min-height:0}
  .panel-inner{display:flex;flex-direction:column;gap:12px;min-height:0}

  /* filters row */
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{padding:8px 12px;border-radius:12px;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.04);cursor:pointer}
  .chip.active{background:linear-gradient(135deg,var(--accent2),var(--accent));box-shadow:0 8px 30px rgba(255,0,0,0.08)}

  /* grid */
  .games-wrap{flex:1;display:flex;min-height:0}
  .games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px;padding:12px;overflow:auto;padding-bottom:24px}
  .game-card{background:linear-gradient(180deg,rgba(20,0,0,0.45),rgba(40,0,0,0.25));border-radius:14px;border:1px solid rgba(255,0,0,0.06);padding:12px;display:flex;flex-direction:column;gap:8px;cursor:pointer;position:relative}
  .game-card img{width:100%;height:140px;object-fit:cover;border-radius:10px;background:#111}
  .game-card h3{margin:0;font-size:16px;color:var(--accent-light)}
  .game-card .meta{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
  .play-btn{padding:8px 10px;border-radius:10px;border:none;background:var(--accent);color:#111;font-weight:700;cursor:pointer}
  .fav{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:9px;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
  .fav.active{background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 6px 18px rgba(255,0,0,0.12)}

  /* iframe area */
  .embed-area{display:none;flex-direction:column;gap:10px;min-height:0}
  .embed-area.active{display:flex}
  .embed-frame{flex:1;border-radius:10px;overflow:hidden;border:2px solid var(--accent2)}
  .embed-frame iframe{width:100%;height:100%;border:0;background:#000}

  /* empty state */
  .empty{padding:30px;text-align:center;color:rgba(255,255,255,0.6)}

  @media (max-width:900px){
    .app{flex-direction:column;padding:12px}
    #sidebar{width:100%;display:flex;flex-direction:row;overflow:auto;padding:12px;gap:10px}
    .logo{display:none}
    .games-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
  }
</style>
</head>
<body>
  <div class="app">
    <aside id="sidebar">
      <div class="logo">
        <div class="logo-icon"><img src="logonobg.png" alt="VIXEL logo"></div>
        <div style="font-size:16px">VIXEL</div>
      </div>

      <nav class="nav">
        <button id="nav-home" class="active" onclick="showTab('home', this)">üè† <span class="small">Home</span></button>
        <button id="nav-games" onclick="showTab('games', this)">üéÆ <span class="small">Games</span></button>
        <button id="nav-ai" onclick="showTabExternal('https://andreyzhorik.github.io/vixel-ai/', this)">ü§ñ <span class="small">AI</span></button>
        <button id="nav-chat" onclick="showTabExternal('https://andreyzhorik.github.io/vixel-chat/', this)">üí¨ <span class="small">Chat</span></button>
        <button id="nav-proxy" onclick="showTab('proxy', this)">üï∂Ô∏è <span class="small">P√∏x-y</span></button>
        <button id="nav-site" onclick="openSite()">üåê <span class="small">Site</span></button>
      </nav>

      <div class="footer-note">Built for Vixel ‚Ä¢ Theme: #000000 / #3D0000 / #950101 / #FF0000</div>
    </aside>

    <main id="main">
      <div class="topbar">
        <div class="title">VIXEL HUB</div>
        <div class="controls">
          <input id="searchInput" class="search" placeholder="search games..." oninput="onSearch()" />
          <button id="btn-favs" class="small-btn" title="Show favorites" onclick="toggleFavoritesView()">‚òÖ Favorites</button>
          <button class="btn" onclick="reloadGames()">Reload</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-inner" id="panelInner">
          <!-- HOME -->
          <div id="page-home" class="page active">
            <h2 style="font-family:Audiowide, sans-serif;color:var(--accent);margin:0 0 8px 0">Welcome</h2>
            <p style="margin:0 0 12px 0;color:var(--muted)">Pick Games / AI / Chat / P√∏x-y from the sidebar. Games load from your games.json and PeteZah fallback. Use search and favorites.</p>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <button class="btn" onclick="showTab('games', document.getElementById('nav-games'))">Play Games</button>
              <button class="btn" onclick="showTab('proxy', document.getElementById('nav-proxy'))">Open P√∏x-y</button>
            </div>
          </div>

          <!-- GAMES -->
          <div id="page-games" class="page" style="display:none;flex-direction:column;min-height:0">
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
              <div class="filters" id="filtersRow"></div>
            </div>

            <div class="games-wrap" style="flex:1;min-height:0">
              <div id="gamesGrid" class="games-grid"></div>

              <div id="embedArea" class="embed-area" style="flex:1;min-height:0">
                <div style="display:flex;gap:10px;align-items:center">
                  <button class="back-button" onclick="closeEmbed()">‚Üê Back</button>
                  <div id="embedTitle" style="font-weight:700;"></div>
                </div>
                <div class="embed-frame" style="flex:1">
                  <iframe id="embedFrame" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
                </div>
              </div>
            </div>
          </div>

          <!-- PROXY -->
          <div id="page-proxy" class="page" style="display:none;">
            <h2 style="color:var(--accent)">P√∏x-y</h2>
            <p style="color:var(--muted)">Opening GRIP inside iframe.</p>
            <div class="embed-frame" style="height:70vh"><iframe src="https://andreyzhorik.github.io/GRIP/" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe></div>
          </div>

          <!-- AI and chat are opened in iframe in new tab so we don't fight CSP -->
        </div>
      </div>
    </main>
  </div>

<script>
/* -------------------------
   Config & helpers
   ------------------------- */
const RAW_USER_JSON = 'https://raw.githubusercontent.com/andreyzhorik/VIXEL/main/games.json';
const PETEZAH_RAW_JSON = 'https://raw.githubusercontent.com/PeteZah-Games/PeteZahGames/main/public/storage/data/games.json';
const PETEZAH_DOMAIN = 'https://petezahgames.com';
const FALLBACK_IMG = 'https://petezahgames.com/storage/images/main/default.jpg';

let allGames = [];      // flattened array of games
let visibleGames = [];  // filtered by search / category / favs
let categories = new Set();
let favorites = loadFavorites(); // Set of labels or unique ids
let showingFavoritesOnly = false;

/* safe url fixer: converts relative /something -> petezah absolute */
function fixUrl(u){
  if(!u) return '';
  // already absolute
  if(u.startsWith('http://') || u.startsWith('https://')) return u;
  // many entries are like "/iframe.html?url=/storage/..." or "/storage/images/..."
  if(u.startsWith('/')) return PETEZAH_DOMAIN + u;
  return u;
}

/* load favorites from localStorage */
function loadFavorites(){
  try{
    const raw = localStorage.getItem('vixel_favs');
    if(!raw) return new Set();
    const arr = JSON.parse(raw);
    return new Set(Array.isArray(arr) ? arr : []);
  }catch(e){return new Set();}
}
function saveFavorites(){
  localStorage.setItem('vixel_favs', JSON.stringify(Array.from(favorites)));
}
function toggleFavorite(id){
  if(favorites.has(id)) favorites.delete(id); else favorites.add(id);
  saveFavorites();
  renderGamesGrid();
}

/* -------------------------
   UI navigation
   ------------------------- */
function clearActiveNav(){
  document.querySelectorAll('#sidebar .nav button').forEach(b => b.classList.remove('active'));
}
function showTab(tab, btnEl){
  clearActiveNav();
  if(btnEl) btnEl.classList.add('active');

  document.querySelectorAll('.page').forEach(p => p.style.display='none');
  if(tab === 'home'){ document.getElementById('page-home').style.display = 'block'; }
  else if(tab === 'games'){ document.getElementById('page-games').style.display = 'flex'; ensureGamesLoaded(); }
  else if(tab === 'proxy'){ document.getElementById('page-proxy').style.display = 'block'; }
  window.scrollTo(0,0);
}
function showTabExternal(url, btnEl){
  // keep the nav active but open external in same tab? user wanted not new tab for ai/chat earlier.
  // But many external sites have CSP that blocks iframes. we'll open in new tab to be safe.
  if(btnEl){ clearActiveNav(); btnEl.classList.add('active'); }
  window.open(url, '_blank', 'noopener');
}
function openSite(){ window.open('https://sites.google.com/view/vixelhub', '_blank', 'noopener'); }

/* -------------------------
   Fetching + normalizing JSON
   ------------------------- */
async function fetchJson(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error('fetch failed ' + res.status);
  return res.json();
}

async function loadAndNormalizeGames(){
  // try user JSON first, then PeteZah fallback (merge)
  let userData = null;
  try{
    userData = await fetchJson(RAW_USER_JSON);
  }catch(e){
    console.warn('user JSON failed', e);
  }

  let peteData = null;
  try{
    peteData = await fetchJson(PETEZAH_RAW_JSON);
  }catch(e){
    console.warn('petezah JSON failed', e);
  }

  // userData may be {games: [...] } or array
  const userArray = normalizeJsonToArray(userData);
  const peteArray = normalizeJsonToArray(peteData);

  // merge: user first, petezah appended (avoid duplicates by label+url)
  const merged = [];
  const seen = new Set();
  function pushUnique(g){
    const key = (g.label||'').trim() + '|' + (g.url||'').trim();
    if(seen.has(key)) return;
    seen.add(key);
    merged.push(normalizeGame(g));
  }
  userArray.forEach(pushUnique);
  peteArray.forEach(pushUnique);

  // build categories set
  categories = new Set();
  merged.forEach(g => {
    (g.categories || []).forEach(c => categories.add(normalizeCategory(c)));
  });

  allGames = merged;
  visibleGames = allGames.slice();
}

/* normalizers */
function normalizeJsonToArray(data){
  if(!data) return [];
  if(Array.isArray(data)) return data;
  if(typeof data === 'object'){
    if(Array.isArray(data.games)) return data.games;
    if(Array.isArray(data.items)) return data.items;
    // maybe nested under public or data
    for(const k of ['data','games_list','list']) if(Array.isArray(data[k])) return data[k];
  }
  return [];
}
function normalizeCategory(c){ return (c||'').toLowerCase().trim(); }
function normalizeGame(g){
  // make sure fields exist and fix relative urls
  return {
    label: g.label || g.title || g.name || 'Untitled',
    url: fixUrl(g.url || g.embed || g.link || ''),
    imageUrl: fixUrl(g.imageUrl || g.image || g.thumbnail || g.thumb || ''),
    categories: (g.categories || g.tags || []).map(x=>normalizeCategory(x)),
    raw: g
  };
}

/* -------------------------
   Render UI: filters + grid
   ------------------------- */
function buildFilters(){
  const row = document.getElementById('filtersRow');
  row.innerHTML = '';

  // categories chips
  const cats = ['all', ...Array.from(categories).slice(0,80)]; // limit safety
  cats.forEach(cat => {
    const btn = document.createElement('div');
    btn.className = 'chip' + (cat === 'all' ? ' active' : '');
    btn.textContent = cat === 'all' ? 'All' : capitalize(cat);
    btn.onclick = () => { document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); applyFilters(); };
    row.appendChild(btn);
  });

  // search is already in topbar; add favorites toggle indicator
  const favChip = document.createElement('div');
  favChip.className = 'chip';
  favChip.innerHTML = '‚òÖ Favorites';
  favChip.onclick = () => { toggleFavoritesView(); };
  row.appendChild(favChip);
}

/* render games grid from visibleGames */
function renderGamesGrid(){
  const container = document.getElementById('gamesGrid');
  container.innerHTML = '';
  if(visibleGames.length === 0){
    container.innerHTML = '<div class="empty">No games found.</div>';
    return;
  }

  visibleGames.forEach(g => {
    const card = document.createElement('div');
    card.className = 'game-card';
    // image
    const img = document.createElement('img');
    img.src = g.imageUrl || FALLBACK_IMG;
    img.onerror = () => { img.src = FALLBACK_IMG; }
    card.appendChild(img);

    // fav button
    const favBtn = document.createElement('div');
    favBtn.className = 'fav' + (favorites.has(g.label) ? ' active' : '');
    favBtn.title = 'Toggle favorite';
    favBtn.innerHTML = favorites.has(g.label) ? '‚ù§' : '‚ô°';
    favBtn.onclick = (e) => { e.stopPropagation(); toggleFavorite(g.label); favBtn.classList.toggle('active'); favBtn.innerHTML = favorites.has(g.label) ? '‚ù§' : '‚ô°'; }
    card.appendChild(favBtn);

    // title
    const title = document.createElement('h3');
    title.textContent = g.label;
    card.appendChild(title);

    // meta/play
    const meta = document.createElement('div');
    meta.className = 'meta';
    const cat = document.createElement('div');
    cat.style.opacity = 0.8; cat.style.fontSize = '12px';
    cat.textContent = (g.categories && g.categories.length) ? g.categories.slice(0,2).map(capitalize).join(', ') : '';
    meta.appendChild(cat);

    const play = document.createElement('button');
    play.className = 'play-btn';
    play.textContent = 'Play';
    play.onclick = (e)=>{ e.stopPropagation(); openEmbed(g); };
    meta.appendChild(play);

    card.appendChild(meta);

    // click opens embed too
    card.onclick = ()=>openEmbed(g);

    container.appendChild(card);
  });
}

/* -------------------------
   Filtering logic
   ------------------------- */
function applyFilters(){
  const activeChip = Array.from(document.querySelectorAll('#filtersRow .chip')).find(c=>c.classList.contains('active'));
  const cat = (activeChip && activeChip.textContent.toLowerCase() !== 'all') ? activeChip.textContent.toLowerCase() : null;
  const q = document.getElementById('searchInput').value.trim().toLowerCase();

  visibleGames = allGames.filter(g=>{
    if(showingFavoritesOnly && !favorites.has(g.label)) return false;
    if(cat && cat !== 'all'){
      // match categories
      if(!g.categories || !g.categories.some(c=>c === cat)) return false;
    }
    if(q){
      if((g.label || '').toLowerCase().indexOf(q) === -1) return false;
      // optionally search categories or other fields
    }
    return true;
  });

  renderGamesGrid();
}
function onSearch(){ applyFilters(); }
function capitalize(s){ if(!s) return ''; return s[0].toUpperCase()+s.slice(1); }

/* -------------------------
   Embedding and playing
   ------------------------- */
function openEmbed(g){
  // show embed area
  document.getElementById('embedArea').classList.add('active');
  document.getElementById('gamesGrid').style.display = 'none';
  document.getElementById('embedTitle').textContent = g.label;

  // convert relative iframe urls
  let src = g.url || '';
  if(!src) { alert('No URL available for this game'); return; }

  // if src looks like "/iframe.html?url=/pages/..." it'll be converted already by fixUrl.
  // Set iframe src:
  const frame = document.getElementById('embedFrame');
  frame.src = src;
  // if the embed page doesn't allow framing (CSP), user will see blank / error in iframe.
}
function closeEmbed(){
  document.getElementById('embedArea').classList.remove('active');
  document.getElementById('gamesGrid').style.display = '';
  document.getElementById('embedFrame').src = '';
}

/* -------------------------
   favorites view toggle
   ------------------------- */
function toggleFavoritesView(){
  showingFavoritesOnly = !showingFavoritesOnly;
  document.getElementById('btn-favs').style.opacity = showingFavoritesOnly ? '1' : '0.8';
  applyFilters();
}

/* -------------------------
   load/reload control
   ------------------------- */
let gamesLoaded = false;
async function ensureGamesLoaded(){
  if(gamesLoaded) return;
  gamesLoaded = true;
  await reloadGames();
}
async function reloadGames(){
  try{
    // load and normalize both sources
    await loadAndNormalizeGames();
    buildFilters();
    applyFilters();
    // default: show games tab
    showTab('games', document.getElementById('nav-games'));
  }catch(e){
    console.error('reload failed', e);
    const grid = document.getElementById('gamesGrid');
    grid.innerHTML = '<div class="empty">Failed to load games. Open console for details.</div>';
  }
}

/* -------------------------
   boot
   ------------------------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  // show home initially
  showTab('home', document.getElementById('nav-home'));
  // preload games in background
  await ensureGamesLoaded();
});

</script>
</body>
</html>
