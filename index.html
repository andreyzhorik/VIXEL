<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vixel Hub ‚Äî Games</title>
<link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#070707;
  --bg2:#3D0000;
  --panel:#150000;
  --accent:#FF0000;
  --accent2:#950101;
  --accent-light:#FF3333;
  --glass: rgba(26,0,0,0.45);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
.app{display:flex;height:100vh;gap:18px;}

/* Sidebar */
.sidebar{
  width:260px;
  padding:22px;
  background:linear-gradient(180deg,rgba(0,0,0,0.95),rgba(61,0,0,0.9));
  border-right:2px solid rgba(255,0,0,0.12);
  display:flex;flex-direction:column;align-items:center;gap:18px;
}
.logo-wrap{
  width:100%;
  display:flex;flex-direction:column;align-items:center;gap:10px;
  background:#120000; /* dark red bg for logo contrast */
  padding:10px;border-radius:14px;border:1px solid rgba(255,0,0,0.12);
}
.logo-icon{width:120px;height:120px;border-radius:14px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:linear-gradient(135deg,var(--accent2),#330000);padding:6px}
.logo-icon img{width:100%;height:100%;object-fit:contain}
.brand{font-family:'Audiowide',sans-serif;color:var(--accent);letter-spacing:2px}

/* nav */
.nav{width:100%;display:flex;flex-direction:column;gap:8px;margin-top:8px}
.nav .btn{padding:12px 14px;border-radius:10px;background:rgba(20,0,0,0.5);border:1px solid rgba(255,0,0,0.06);text-align:center;cursor:pointer;color:#fff}
.nav .btn.active{background:linear-gradient(135deg,var(--accent2),rgba(255,0,0,0.18));box-shadow:0 6px 18px rgba(255,0,0,0.08);border-left:4px solid var(--accent)}

/* main */
.main{flex:1;padding:26px;overflow:hidden;display:flex;flex-direction:column;gap:18px}
.header{display:flex;align-items:center;justify-content:space-between}
.title{font-family:'Audiowide',sans-serif;font-size:26px;color:var(--accent)}
.controls{display:flex;gap:8px;align-items:center}

/* home quick cards (kept minimal) */
.quick-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:16px}

/* games area */
.games-area{flex:1;display:flex;flex-direction:column;gap:12px;min-height:0}
.filters{display:flex;gap:8px;flex-wrap:wrap}
.category-btn{padding:8px 14px;border-radius:12px;background:rgba(20,0,0,0.45);border:1px solid rgba(255,0,0,0.06);cursor:pointer;color:#eee}
.category-btn.active{background:linear-gradient(135deg,var(--accent2),var(--accent));box-shadow:0 6px 18px rgba(255,0,0,0.06);color:white}

/* grid */
.games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px;padding:8px;overflow:auto;min-height:0}
.game-card{background:linear-gradient(135deg,rgba(26,0,0,0.6),rgba(61,0,0,0.4));border:1px solid rgba(255,0,0,0.06);border-radius:14px;padding:12px;cursor:pointer;display:flex;flex-direction:column;gap:10px}
.game-card img{width:100%;height:140px;object-fit:cover;border-radius:10px;border:2px solid rgba(255,0,0,0.06)}
.game-card h3{margin:0;font-size:16px;color:var(--accent-light)}

/* embed */
.embed-wrap{display:none;flex-direction:column;gap:12px}
.embed-wrap.active{display:flex}
.embed-frame{height:calc(100vh - 220px);width:100%;border-radius:10px;border:2px solid var(--accent2);overflow:hidden}
.embed-frame iframe{width:100%;height:100%;border:0;background:#000}

/* utilities */
.note{color:rgba(255,255,255,0.7);font-size:13px}
.footer{font-size:13px;color:rgba(255,255,255,0.6);display:flex;justify-content:space-between;align-items:center}

/* small screens */
@media (max-width:900px){.sidebar{display:none}.games-grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="app">

  <aside class="sidebar">
    <div class="logo-wrap">
      <div class="logo-icon"><img id="logoImg" src="logonobg.png" alt="Vixel"></div>
      <div class="brand">VIXEL</div>
    </div>

    <nav class="nav" role="navigation">
      <div class="btn active" data-page="home" onclick="navTo('home', this)">Home</div>
      <div class="btn" data-page="games" onclick="navTo('games', this)">Games</div>
      <div class="btn" data-page="ai" onclick="navTo('ai', this)">AI</div>
      <div class="btn" data-page="chat" onclick="navTo('chat', this)">Chat</div>
      <div class="btn" data-page="proxy" onclick="navTo('proxy', this)">P√∏x-y</div>
      <div class="btn" onclick="openSite()">Site</div>
    </nav>

    <div style="margin-top:auto;font-size:12px;color:rgba(255,255,255,0.6);text-align:center">
      built for VIXEL ‚Äî <span id="status">loading...</span>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div class="title">Vixel Hub</div>
      <div class="controls">
        <div class="note" id="gamesCount"></div>
      </div>
    </div>

    <!-- Pages -->
    <div id="page-home" class="page active">
      <div class="quick-grid">
        <div style="background:var(--glass);padding:18px;border-radius:12px">
          <h3 style="margin:0;color:var(--accent)">Welcome</h3>
          <p class="note">Play games inline, use AI, chat, and P√∏x-y. Click Games to load the full list.</p>
        </div>
        <div style="background:var(--glass);padding:18px;border-radius:12px">
          <h3 style="margin:0;color:var(--accent)">Tip</h3>
          <p class="note">If some games 404, the script will try to auto-fix relative links to PeteZah's domain.</p>
        </div>
      </div>
    </div>

    <div id="page-games" class="page" style="display:none">
      <div class="games-area">
        <div class="filters" id="filters"></div>
        <div class="games-grid" id="gamesGrid" role="list"></div>

        <div class="embed-wrap" id="embedWrap">
          <button class="btn" onclick="backToGrid()" style="background:linear-gradient(90deg,var(--accent2),var(--accent));border:none;padding:10px 14px;border-radius:10px">‚Üê Back</button>
          <div class="embed-frame" id="embedFrame"><iframe id="gameIframe" src="" frameborder="0" allowfullscreen></iframe></div>
        </div>
      </div>
    </div>

    <div id="page-ai" class="page" style="display:none">
      <div style="background:var(--glass);padding:18px;border-radius:12px">
        <h3 style="color:var(--accent)">AI</h3>
        <p class="note">AI page embedded below.</p>
        <div style="height:520px;border-radius:10px;overflow:hidden;border:2px solid var(--accent2)"><iframe src="https://andreyzhorik.github.io/vixel-ai/" style="width:100%;height:100%;border:0"></iframe></div>
      </div>
    </div>

    <div id="page-chat" class="page" style="display:none">
      <div style="background:var(--glass);padding:18px;border-radius:12px">
        <h3 style="color:var(--accent)">Chat</h3>
        <div style="height:520px;border-radius:10px;overflow:hidden;border:2px solid var(--accent2)"><iframe src="https://andreyzhorik.github.io/vixel-chat/" style="width:100%;height:100%;border:0"></iframe></div>
      </div>
    </div>

    <div id="page-proxy" class="page" style="display:none">
      <div style="background:var(--glass);padding:18px;border-radius:12px">
        <h3 style="color:var(--accent)">P√∏x-y</h3>
        <div style="height:520px;border-radius:10px;overflow:hidden;border:2px solid var(--accent2)"><iframe src="https://andreyzhorik.github.io/GRIP/" style="width:100%;height:100%;border:0"></iframe></div>
      </div>
    </div>

    <div class="footer">
      <div class="note">Made with üî•</div>
      <div class="note" id="debug"></div>
    </div>
  </main>
</div>

<script>
/*
  Vixel hub games loader:
  - Attempts to fetch your repo games.json (raw).
  - Falls back to PeteZah's games JSON.
  - If both fail, uses a tiny embedded sample.
  - Fixes relative URLs ("/...") to point at https://petezahgames.com
*/

// Raw URLs we'll try (order matters)
const RAW_YOUR_JSON = "https://raw.githubusercontent.com/andreyzhorik/VIXEL/main/games.json";
const RAW_PETEZAH_JSON = "https://raw.githubusercontent.com/PeteZah-Games/PeteZahGames/main/public/storage/data/games.json";

let allGames = [];
let categoriesSet = new Set();
const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");
const gamesCountEl = document.getElementById("gamesCount");

// small fallback data (keeps UI usable)
const FALLBACK = {
  games: [
    { label: "Fallback-1", imageUrl: "https://petezahgames.com/storage/images/main/default.jpg", url: "/iframe.html?url=/storage/ag/g/tag", categories: ["action"] },
    { label: "Fallback-2", imageUrl: "https://petezahgames.com/storage/images/main/default.jpg", url: "/iframe.html?url=/storage/ag/g/polytrack/", categories: ["racing"] }
  ]
};

function fixUrl(url){
  if(!url) return "";
  try{
    // if absolute already, return untouched
    const u = new URL(url, "https://example.invalid");
    if(u.protocol === "http:" || u.protocol === "https:"){
      // if original url had scheme, return original (handles full urls)
      if(url.startsWith("http://") || url.startsWith("https://")) return url;
    }
  }catch(e){
    // fall through
  }
  // If starts with '/', assume PeteZah origin (their assets + iframe path)
  if(url.startsWith("/")) return "https://petezahgames.com" + url;
  // If it's a relative path that begins with 'storage' or similar, prefix with PeteZah too
  if(!url.startsWith("http") && (url.startsWith("storage") || url.startsWith("pages") || url.startsWith("iframe.html"))) {
    return "https://petezahgames.com/" + url.replace(/^\/+/, "");
  }
  // otherwise return as-is
  return url;
}

async function tryFetch(url){
  try{
    const res = await fetch(url, {cache: "no-cache"});
    if(!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    return json;
  }catch(err){
    console.warn("fetch failed", url, err);
    debugEl.textContent = `fetch fail ${url} ‚Äî ${err}`;
    return null;
  }
}

async function loadJSONAndInit(){
  statusEl.textContent = "loading JSON...";
  let data = await tryFetch(RAW_YOUR_JSON);
  if(!data){
    statusEl.textContent = "fallback: trying PeteZah JSON...";
    data = await tryFetch(RAW_PETEZAH_JSON);
  }
  if(!data){
    statusEl.textContent = "using embedded fallback";
    data = FALLBACK;
  } else {
    statusEl.textContent = "games loaded";
  }

  // support both shapes: root array OR { games: [...] }
  if(Array.isArray(data)) {
    allGames = data;
  } else if(data.games && Array.isArray(data.games)) {
    allGames = data.games;
  } else {
    // try to find array property
    const arr = Object.values(data).find(v => Array.isArray(v));
    allGames = arr || FALLBACK.games;
  }

  // normalize & collect categories
  categoriesSet.clear();
  allGames = allGames.map(g => {
    const safe = {
      label: g.label || g.title || "Untitled",
      imageUrl: g.imageUrl || g.image || g.img || "",
      url: g.url || g.embed || g.link || "",
      categories: g.categories || g.tags || []
    };
    // fix relative urls
    safe.imageUrl = fixUrl(safe.imageUrl);
    safe.url = fixUrl(safe.url);
    // ensure categories lowercased canonical for UI
    safe.categories = (safe.categories||[]).map(c=>String(c).toLowerCase());
    safe.categories.forEach(c => categoriesSet.add(c));
    return safe;
  });

  // Add 'all' and nice sorted categories
  const categories = Array.from(categoriesSet).filter(Boolean).sort();
  renderCategoryFilters(categories);
  renderGamesGrid(allGames);
  gamesCountEl.textContent = `${allGames.length} games`;
  statusEl.textContent = "ready";
}

// UI rendering
function renderCategoryFilters(categories){
  const filters = document.getElementById("filters");
  filters.innerHTML = '';
  // All button
  const allBtn = createCategoryBtn('all','All', true);
  filters.appendChild(allBtn);
  // dynamic categories
  categories.forEach(cat => {
    const label = cat.replace(/-/g,' ');
    filters.appendChild(createCategoryBtn(cat, label, false));
  });
}

function createCategoryBtn(catKey, display, active){
  const btn = document.createElement('button');
  btn.className = 'category-btn' + (active ? ' active' : '');
  btn.textContent = display;
  btn.onclick = () => {
    document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    filterByCategory(catKey);
  };
  return btn;
}

function filterByCategory(cat){
  const key = String(cat).toLowerCase();
  if(key === 'all') {
    renderGamesGrid(allGames);
    return;
  }
  const filtered = allGames.filter(g => (g.categories||[]).some(c => c === key || c.replace(/\s+/g,'') === key.replace(/\s+/g,'')));
  renderGamesGrid(filtered);
}

// render grid
function renderGamesGrid(list){
  const grid = document.getElementById("gamesGrid");
  document.getElementById("embedWrap").classList.remove('active');
  grid.innerHTML = '';
  if(!list.length){
    grid.innerHTML = `<div class="note">No games found.</div>`;
    return;
  }
  list.forEach(g => {
    const card = document.createElement('div');
    card.className = 'game-card';
    const img = document.createElement('img');
    img.src = g.imageUrl || 'https://petezahgames.com/storage/images/main/default.jpg';
    img.alt = g.label;
    img.onerror = () => { img.src = 'https://petezahgames.com/storage/images/main/default.jpg'; };
    const h3 = document.createElement('h3');
    h3.textContent = g.label;
    card.appendChild(img);
    card.appendChild(h3);
    card.onclick = () => openGameInEmbed(g);
    grid.appendChild(card);
  });
}

function openGameInEmbed(game){
  // Some PeteZah game urls are like /iframe.html?url=/storage/...
  // We already fixed to full URL. Some embed pages disallow framing; that's outside our control.
  const iframe = document.getElementById('gameIframe');
  document.getElementById('gamesGrid').scrollTop = 0;
  document.getElementById('embedWrap').classList.add('active');
  iframe.src = game.url || '';
  // show debug if iframe 404 or blocked - cannot access cross-origin, but user will see message in console
  debugEl.textContent = `loading ${game.url}`;
}

function backToGrid(){
  const iframe = document.getElementById('gameIframe');
  iframe.src = '';
  document.getElementById('embedWrap').classList.remove('active');
}

// nav actions
function navTo(page, el){
  document.querySelectorAll('.nav .btn').forEach(b=>b.classList.remove('active'));
  if(el) el.classList.add('active');
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  const pg = document.getElementById('page-'+page);
  if(pg) pg.style.display = 'block';
  // if switching to games and not yet loaded, ensure loaded
  if(page === 'games') {
    // nothing special: data loaded at startup
  }
}
function openSite(){ window.open('https://sites.google.com/view/vixelhub','_blank','noopener'); }

// initialize
document.addEventListener('DOMContentLoaded', () => {
  loadJSONAndInit();
  // set initial page home
  navTo('home', document.querySelector('.nav .btn[data-page="home"]'));
});
</script>
</body>
</html>
