<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vixel Chat</title>
<style>
:root {
  --bg:#000;
  --panel:#1a0000;
  --accent1:#3D0000;
  --accent2:#950101;
  --accent3:#FF0000;
  --text:#fff;
  --input-bg:#111;
}
body{margin:0;font-family:sans-serif;background:#000;color:var(--text)}
#logo{display:block;margin:10px auto;width:120px}
#chat-container{display:flex;flex-direction:column;height:95vh;margin:0 auto;width:400px;background:var(--panel);border:2px solid var(--accent3);border-radius:10px;overflow:hidden}
#messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column-reverse}
.message{margin:3px 0;padding:4px 6px;border-radius:5px;background:rgba(255,0,0,0.1)}
.message .username{font-weight:bold;margin-right:5px}
.message .text{white-space:pre-wrap;word-wrap:break-word}
#input-container{display:flex;padding:5px;background:var(--panel);border-top:2px solid var(--accent3)}
#msg{flex:1;padding:5px;border-radius:5px;border:none;background:var(--input-bg);color:#fff}
#msg:focus{outline:none}
#send{padding:5px 10px;margin-left:5px;background:var(--accent3);color:#fff;border:none;border-radius:5px;cursor:pointer}
#users{background:#150000;color:#fff;padding:5px;overflow-y:auto;max-height:100px}
.user{margin:2px 0}
.color-btn{width:20px;height:20px;display:inline-block;margin-right:2px;cursor:pointer;border:1px solid #fff;border-radius:3px}
#moreName,#moreAvatar{cursor:pointer;margin-left:5px;color:var(--accent3)}
.hidden{display:none}
</style>
</head>
<body>
<img id="logo" src="https://raw.githubusercontent.com/andreyzhorik/VIXEL/main/logonobg.png" alt="Vixel Logo">
<div id="chat-container">
  <div id="messages"></div>
  <div id="users"></div>
  <div id="input-container">
    <textarea id="msg" rows="1" placeholder="Type a message..."></textarea>
    <button id="send">Send</button>
  </div>
</div>

<div id="settings" style="padding:10px;color:#fff;">
  Name color:
  <span class="color-btn" style="background:red" data-type="name" data-color="#FF0000"></span>
  <span class="color-btn" style="background:yellow" data-type="name" data-color="#FFFF00"></span>
  <span class="color-btn" style="background:green" data-type="name" data-color="#00FF00"></span>
  <span class="color-btn" style="background:blue" data-type="name" data-color="#00FFFF"></span>
  <span id="moreName">More</span><br>
  Avatar color:
  <span class="color-btn" style="background:red" data-type="avatar" data-color="#FF0000"></span>
  <span class="color-btn" style="background:yellow" data-type="avatar" data-color="#FFFF00"></span>
  <span class="color-btn" style="background:green" data-type="avatar" data-color="#00FF00"></span>
  <span class="color-btn" style="background:blue" data-type="avatar" data-color="#00FFFF"></span>
  <span id="moreAvatar">More</span>
</div>

<script>
const API_URL = "https://ehciyxvbasqiiiurjuwu.supabase.co/rest/v1";
const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoY2l5eHZiYXNxaWlpdXJqdXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzQzNTgsImV4cCI6MjA3OTY1MDM1OH0.yMZ8EqtPXJumjn2xHTXwG3jbWTNdDxrklYIkdXNcbQk";
const USERNAME = prompt("Enter your username:").slice(0,20);
let nameColor = "#FF0000";
let avatarColor = "#FF0000";
const badWords = ["badword1","badword2"];
let lastNameChange = 0;

const messagesEl = document.getElementById("messages");
const usersEl = document.getElementById("users");
const msgInput = document.getElementById("msg");

function sanitize(text){
  badWords.forEach(w => {text = text.replace(new RegExp(w,"gi"),"*".repeat(w.length))});
  return text;
}

function addMessage(user,text,nameC,avC){
  const div = document.createElement("div");
  div.className="message";
  div.innerHTML=`<span class="username" style="color:${nameC}">${user}</span>: <span class="text" style="color:${avC}">${text}</span>`;
  messagesEl.prepend(div);
}

function addUser(user,nameC,avC,online){
  if(document.getElementById("user_"+user)) return;
  const div = document.createElement("div");
  div.className="user";
  div.id="user_"+user;
  div.textContent=user+" "+(online?"ðŸŸ¢":"ðŸ”´");
  div.style.color=nameC;
  usersEl.appendChild(div);
}

function updateOnline(user,online){
  const el = document.getElementById("user_"+user);
  if(el) el.textContent=user+" "+(online?"ðŸŸ¢":"ðŸ”´");
}

async function fetchPresence(){
  try{
    const res = await fetch(`${API_URL}/presence?select=username,name_color,avatar_color,online`,{
      headers:{apikey:API_KEY,"Authorization":"Bearer "+API_KEY}
    });
    const data = await res.json();
    usersEl.innerHTML="";
    data.forEach(u=>{
      addUser(u.username,u.name_color||"#FF0000",u.avatar_color||"#FF0000",u.online);
    });
  }catch(e){console.error("presence fetch err",e);}
}

async function fetchMessages(){
  try{
    const res = await fetch(`${API_URL}/messages?select=user,text,created_at&order=created_at.asc&limit=200`,{
      headers:{apikey:API_KEY,"Authorization":"Bearer "+API_KEY}
    });
    const data = await res.json();
    messagesEl.innerHTML="";
    data.forEach(m=>{
      addMessage(m.user,m.text,nameColor,avatarColor);
    });
  }catch(e){console.error("messages fetch err",e);}
}

async function goOnline(){
  try{
    await fetch(`${API_URL}/presence`,{
      method:"POST",
      headers:{apikey:API_KEY,"Authorization":"Bearer "+API_KEY,"Content-Type":"application/json"},
      body:JSON.stringify({username:USERNAME,online:true,name_color:nameColor,avatar_color:avatarColor,lastseen:new Date().toISOString()})
    });
  }catch(e){console.error("online err",e);}
}

async function sendMessage(){
  let text = sanitize(msgInput.value.trim());
  if(!text) return;
  await fetch(`${API_URL}/messages`,{
    method:"POST",
    headers:{apikey:API_KEY,"Authorization":"Bearer "+API_KEY,"Content-Type":"application/json"},
    body:JSON.stringify({user:USERNAME,text})
  });
  addMessage(USERNAME,text,nameColor,avatarColor);
  msgInput.value="";
}

msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

document.getElementById("send").addEventListener("click",sendMessage);

document.querySelectorAll(".color-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    if(btn.dataset.type==="name") nameColor=btn.dataset.color;
    else avatarColor=btn.dataset.color;
    goOnline();
  });
});

document.getElementById("moreName").addEventListener("click",()=>{
  const c = prompt("Enter hex color for name","#FF0000");
  if(/^#[0-9A-F]{6}$/i.test(c)) {nameColor=c; goOnline();}
});
document.getElementById("moreAvatar").addEventListener("click",()=>{
  const c = prompt("Enter hex color for avatar","#FF0000");
  if(/^#[0-9A-F]{6}$/i.test(c)) {avatarColor=c; goOnline();}
});

fetchPresence();
fetchMessages();
goOnline();
setInterval(fetchPresence,5000);
setInterval(fetchMessages,3000);
</script>
</body>
</html>
